<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/matrix-style2.css" />
<link rel="stylesheet" href="bootstrap-table/bootstrap-dialog.css" />

<link rel="stylesheet" href="css/bootstrap.min.css" />
<link rel="stylesheet" href="bootstrap-table/bootstrap-table.css"/>

<script src="../js/jquery-3.5.1.min.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src="bootstrap-table/bootstrap-table.js"></script>
<script src="bootstrap-table/bootstrap-dialog.js"></script>
<script src="bootstrap-table/bootstrap-table-zh-CN.js"></script>
</head>
<body>
<div id="body">
<div id="content">
  <div id="content-header">
      <h1>产品管理</h1>
  </div>
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="widget-box">
          <div class="widget-content">
          	<div style="width:98.5%;height:30px;">
            	<div style="width:50%;float:left;">&nbsp;</div>
            	<div style="width:50%;float:left;">
            		<div style="float:right;">
			       		<button class="btn btn-info" id="saveButton" data-toggle="modal" data-target="#myModal" style="">新增</button>
            		</div>
            	</div>
            </div>
            <div id="toolbar" style="width:100%;border-top:1px solid #CDCDB4;padding-top:10px;">
          		<div style="float:left">
	          		<div style="float:left;margin-top:5px;">
			     		项目名称：
	          		</div>
	          		<div style="float:left;">
			     		<input type="text" id="queryName" placeholder="请输入项目名称"/>&nbsp;&nbsp;&nbsp;
	          		</div>
          		</div>
          		<div style="float:left">
	          		<div style="float:left;margin-top:5px;">
			     		类别：
	          		</div>
	          		<div style="float:left;">
			     		<select id="queryTypeName">
			     			<option value="" disabled selected hidden>请选择类别</option>
			     		</select>&nbsp;&nbsp;&nbsp;
	          		</div>
          		</div>
          		<div style="float:left">
			        <div style="float:left;">
			        	&nbsp;&nbsp;&nbsp;<button class="btn btn-info" id="queryTable">查询</button>
			        </div>
			        <div style="float:left;">
			        	&nbsp;<button class="btn btn-danger" id="clearTable">清空</button>
			        </div>
			    </div>
            	<div style="clear:both;"></div>
            </div>
          	<table id="table" style="white-space:nowrap;overflow: hidden"></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"  data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">项目修改</h4>
      </div>
      <!-- <div class="modal-body" > -->
      <div>
     	<div style="width:25%;float:left;text-align:right;height:20px;"></div>
     	<div style="width:75%;float:left;height:20px;">
     		<input type="hidden" class="form-control" name="sysId" id="sysId"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right;">项目名称：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="name" id="name"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right;">说明：</div>
     	<div style="width:75%;float:left;">
     		<textarea class="form-control" name="remark" id="remark"></textarea>
     	</div>
     	<div style="width:25%;float:left;text-align:right">价格：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="price" id="price" onkeyup="value=value.replace(/[^\d^\.]+/g,'').replace('.','$#$').replace(/\./g,'').replace('$#$','.').replace(/\b(0+)/gi,'')"/>
     	</div>
     	<div id="lb">
	     	<div style="width:25%;float:left;text-align:right;">轮播：</div>
	     	<div style="width:75%;float:left;">
	        	<input type="file" name="file" accept="image/*" id="handPhoto" multiple="multiple">
	     	</div>
     	</div>
     	<div id="xq">
	     	<div style="width:25%;float:left;text-align:right;">详情：</div>
	     	<div style="width:75%;float:left;">
	        	<input type="file" name="file" accept="image/*" id="photoAdrr" multiple="multiple">
	     	</div>
     	</div>
     	<div id="hdzk">
     		<div style="width:25%;float:left;text-align:right">折扣数：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" name="discount" id="discount" onkeyup="value=value.replace(/[^\d^\.]+/g,'').replace('.','$#$').replace(/\./g,'').replace('$#$','.')"/>
	     	</div>
	     	<div style="width:25%;float:left;text-align:right">折扣价：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" name="amount" id="amount" readonly/>
	     	</div>
     	</div>
     	<div style="width:25%;float:left;text-align:right">分类：</div>
     	<div style="width:75%;float:left;">	
     		<select class="form-control" name="typeName" id="typeName">
     		</select>
     	</div>
     	<div style="width:25%;float:left;text-align:right">状态：</div>
     	<div style="width:75%;float:left;">	
     		<select class="form-control" name="status" id="status">
     			<option value="0">上线</option>
     			<option value="1">下线</option>
     		</select>
     	</div>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
        <button type="button" class="btn btn-primary" onclick="submit()">提交</button>
      </div>
    </div>
  </div>
</div>
</div>
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" style="height:300px;width:400px;overflow:scroll">
	<button style="padding:10px 10px 0 0;" type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeImg">关闭</button>
	<div id="igd"><img src="" id="imgAdrr"/></div><div id="igd1"><img src="" id="imgAdrr1"/><div style="height:10px;"></div><img src="" id="imgAdrr2"/></div>
</div>
<script type="text/javascript">

$(document).ready(function(){ 
	$("#myModal").hide()
	$("#myModal1").hide()
	$.ajax({
		type:"POST",
		url:"/msProjectType/getMsProjectTypeList?token="+localStorage.getItem("token"),
		contentType:'application/json',
		data:JSON.stringify({status:'0'}),
		success:function(res){
			if(res.status=="01"){
				for(var i=0;i<res.rows.length;i++){
					$("#typeName").append("<option>"+res.rows[i].name+"</option>")
					$("#queryTypeName").append("<option>"+res.rows[i].name+"</option>")
				}
			}else{
				alert(res.message)
			}
		}
	})
	init();
});

var dialog=null
function init(){
	$('#table').bootstrapTable('destroy').bootstrapTable({
	    url: "/serviceProject/getServiceProjectList?token="+localStorage.getItem("token"),
	    pagination: true,
	    method:"post",
	    height:"400",
	    queryParams : function(params) {//上传服务器的参数
	    	var temp = {
	   			name:$("#queryName").val(),
	   			typeName:$("#queryTypeName").val(),
	            offset :params.offset + 0,// SQL语句起始索引
	            pageNumber : params.limit  // 每页显示数量
	        };
	        return temp;
	    },
	    columns: [{
	   	    field: 'id',
	   	    title: '序号',
	   	    formatter: function (value, row, index) {
	   	        return index+1;
	   	    }
	   	},{
	    	field: 'sysId',
	    	align:'center',
	        title: '主键',
	        visible: false
	    },{
	        field: 'name',
	        align:'left',
	        halign:"center",
	        title: '项目名称'
	    },{
	        field: 'price',
	        align:'center',
	        title: '价格'
	   /*  },{
	        field: 'discount',
	        align:'center',
	        title: '折扣数'
	    },{
	        field: 'amount',
	        align:'center',
	        title: '成交价' */
	    },{
	        field: 'remark',
	        align:'left',
	        halign:"center",
	        title: '说明',
	        formatter:paramsMatter,
	        cellStyle:formatTableUnit
	    },{
	        field: 'typeName',
	        align:'center',
	        title: '类别' 
	    },{
	    	field: 'photoAdrr',
	    	align:'center',
	    	title: '详情图片地址',
	        formatter:function(value,row,index){
	            var s = '<a  data-toggle="modal" data-target="#myModal1"  id="showPhoto"  href="javascript:void(0)">';
	            if(row.photoAdrr != "" && row.photoAdrr != null){
	    			s = s+'<img style="width:70;height:20px;"  src="'+row.photoAdrr+'" /></a>';
	    		}
	            return s;
	        },
	        events: window.operateEvents = {
	  			'click #showPhoto': function (e, value, row, index) {
	  		    	$("#igd1").hide()
	  		    	$("#igd").show()
	  		    	$("#imgAdrr").attr('src', row.photoAdrr)
	  		    },
	       	}
	    },{
	    	field: 'handPhoto',
	    	title: '详情轮播图片',
	        events: 'operateEvents',
	    	formatter: function (value, row, index) {
	    		var pt = []
	    		if(row.handPhoto != "" && row.handPhoto != null){
	    			pt.push(row.handPhoto.split(",")[0])
	    			pt.push(row.handPhoto.split(",")[1])
	    		}
	    		var s = '<a  data-toggle="modal" data-target="#myModal1"  id="showPhoto1"  href="javascript:void(0)">'
	    		if(pt.length > 0){
		    		for(var i=0;i<pt.length;i++){
			    		if(s == null){
			    			s = s+'<img style="width:70;height:20px;"  src="'+pt[i]+'" />';
			    		}else{
			    			s = s+'</br><img style="width:70;height:20px;"  src="'+pt[i]+'" /></a>';
			    		}
		    		}
		    		s = s+'</a>'
	    		}
		    	return s;
	    	},
	    	events: window.operateEvents = {
	   			'click #showPhoto1': function (e, value, row, index) {
	   				$("#igd").hide()
	   				$("#igd1").show()
	   		    	$("#imgAdrr1").attr('src', row.handPhoto.split(",")[0])
	   		    	$("#imgAdrr2").attr('src', row.handPhoto.split(",")[1])
	   		    },
	    	}
	    },{
	        field: 'clickNum',
	        align:'center',
	        title: '点击次数' 
	    },{
	        field: 'userName',
	        align:'center',
	        title: '操作人'
	    },{
	        field: 'status',
	        align:'center',
	        title: '状态',
	        formatter:function(value,row,index){
	        	if(row.status=='0'){
	        		return '<span style="color:#00ff00">上线</span>';
	        	}else{
	        		return '<span style="color:#FF0000">下线</span>';
	        	}
	        }
	    },{
	        field: 'createTime',
	        align:'center',
	        title: '创建时间'
	    },{
	    	field:'operate',
	    	align:'center',
	    	title:'操作',
	    	events: window.operateEvents = {
	   			'click #editTable': function(e, value, row, index) {
	   				dialog=0
	   				$("#myModalLabel").html("修改");
	   				$("#name").val(row.name);
	   				$("#price").val(row.price);
	   				$("#remark").val(row.remark);
	   				$("#amount").val(row.amount);
	   				$("#status").val(row.status);
	   				$("#discount").val(row.discount);
	   				$("#sysId").val(row.sysId);
	   				$("#xq").hide();
	   				$("#lb").hide();
	   				$("#hdzk").show();
	   			},
	   			'click #deltTable': function(e, value, row, index) {
	   				if(confirm("确定要执行该操作？")){
	   					$.ajax({
	   						type:"post",
	   						url:"/serviceProject/deleteServiceProject?token="+localStorage.getItem("token"),
	   						data:JSON.stringify({"sysId":row.sysId}),
	   						contentType:'application/json',
	   						success:function(res){
	   							if(res.status=="01"){
	   								$("#myModal").modal('hide');
	   								$("#table").bootstrapTable('refresh');
	   							}else{
	   								alert(res.message)
	   							}
	   						}
	   					})
	   				}
	   			}
	   		},
	    	formatter:function(value,row,index){
	    		return '<button class="btn btn-info" id="editTable" data-toggle="modal" data-target="#myModal">修改</button>&nbsp;'+
	    		'<button class="btn btn-danger" id="deltTable">删除</button>'
	    	}
	    }]
	});
}
//点击之后放到图片
window.operateEvents1 = {
    'click #showPhoto1': function (e, value, row, index) {
    	$("#imgAdrr").hide()
    	$("#imgAdrr1").attr('src', row.handPhoto.split(",")[0])
    	$("#imgAdrr2").attr('src', row.handPhoto.split(",")[1])
    },
};
function submit(){
	var data=null;
	var form = new FormData();
	if($("#name").val() == ""){
		alert("项目名称不能为空！");
	}else if($("#remark").val() == ""){
		alert("项目介绍不能为空！")
	}else if($("#remark").val().length > 54){
		alert("项目介绍字数不能超过54！")
	}else if($("#price").val() == ""){
		alert("价格不能为空！")
	}else if($("#typeName").val() == null){
		alert("产品分类不能为空！")
	}else{
		var data=JSON.stringify({
			"status":$("#status").val(),
			"name":$("#name").val(),
			"remark":$("#remark").val(),
			"typeName":$("#typeName").val(),
			"price":$("#price").val(),
			"amount":$("#amount").val(),
			"discount":$("#discount").val(),
			"sysId":$("#sysId").val()
		})
		if(dialog==0){
			$.ajax({
				type:"post",
				url:"/serviceProject/updateServiceProject?token="+localStorage.getItem("token"),
				contentType:'application/json',
				data:data,
				success:function(res){
					if(res.status=="01"){
						alert(res.rows)
						$("#myModal").modal('hide');
						$("#table").bootstrapTable('refresh');
					}else{
						alert(res.message)
					}
				}
			})
		}else{
			if($("#photoAdrr").val() == ""){
				alert("请上传详情图片！")
			}else if($("#handPhoto").val() == ""){
				alert("请上传轮播图片！")
			}else if(document.getElementById("photoAdrr").files > 1){
				alert("最多上传1张详情图片！")
			}else if(document.getElementById("handPhoto").files.length != 2){
				alert("请上传2张轮播图片！")
			}else{
				form.append("detailFile", document.getElementById("photoAdrr").files[0]);
		     	form.append("vo", data);
	     		var length = document.getElementById("handPhoto").files.length;
	     		var form1 = new FormData();
     			form1.append("handFile", document.getElementById("handPhoto").files[0]);
	     		$.ajax({
					type:"post",
					url:"/serviceProject/addHandFile?token="+localStorage.getItem("token"),
					contentType:false,
					processData: false,
					data:form1,
					success:function(res){
						if(res.status == "01"){
							var form2 = new FormData();
				     		form2.append("handFile", document.getElementById("handPhoto").files[1]);
				     		$.ajax({
								type:"post",
								url:"/serviceProject/addHandFile?token="+localStorage.getItem("token"),
								contentType:false,
								processData: false,
								data:form2,
								success:function(res){
									if(res.status == "01"){
										$.ajax({
											type:"post",
											url:"/serviceProject/saveServiceProject?token="+localStorage.getItem("token"),
											contentType:false,
											processData: false,
											data:form,
											success:function(res){
												if(res.status=="01"){
													alert(res.rows)
													$("#myModal").modal('hide');
													$("#table").bootstrapTable('refresh');
												}else{
													alert(res.message)
												}
											}
										})
									}
								}
							})
						}
					}
				})
			}
		}
	}
}

$("#saveButton").click(function(){
	dialog=1
	$("#myModal1").hide();
	$("#xq").show();
	$("#lb").show();
	$("#hdzk").hide();
	$("#myModalLabel").html("新增");
	$("#name").val("");
	$("#price").val("");
	$("#remark").val("");
	$("#amount").val("");
	$("#typeName").val("");
	$("#status").val("0");
	$("#photoAdrr").val("");
	$("#handPhoto").val("");
})

//表格超出宽度鼠标悬停显示td内容
function paramsMatter(value, row, index) {
    var span = document.createElement("span");
    span.setAttribute("title", value);
    span.innerHTML = value;
    return span.outerHTML;
}
//td宽度以及内容超过宽度隐藏
function formatTableUnit(value, row, index) {
    return {
        css: {
            "white-space": "nowrap",
            "text-overflow": "ellipsis",
            "overflow": "hidden",
            "max-width": "150px"
        }
    }
}        

$("#discount").keyup(function(){
	if($("#price").val() != null){
		$("#amount").val(($("#price").val()*$("#discount").val()/10).toFixed(2))
	}
})
</script>
<script src="getMsUser.js"></script>
</body>
</html>
