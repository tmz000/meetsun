<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/matrix-style2.css" />
<link rel="stylesheet" href="bootstrap-table/bootstrap-dialog.css" />

<link rel="stylesheet" href="css/bootstrap.min.css" />
<link rel="stylesheet" href="bootstrap-table/bootstrap-table.css"/>
<link href="bootstrap-table/bootstrapValidator.min.css" rel="stylesheet" />
<script src="../js/jquery-3.5.1.min.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src="bootstrap-table/bootstrap-table.js"></script>
<script src="bootstrap-table/bootstrap-dialog.js"></script>
<script src="bootstrap-table/bootstrap-table-zh-CN.js"></script>
<script src="bootstrap-table/bootstrapValidator.min.js"></script>
</head>
<body>
<div id="body">
<div id="content">
  <div id="content-header">
      <h1>客户管理</h1>
  </div>
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="widget-box">
          <div class="widget-content">
	       	<button class="btn btn-info" id="saveMsCustom" data-toggle="modal" data-target="#myModal" style="float:right">新增</button>&nbsp;&nbsp;&nbsp;
          	<table id="table" style="white-space:nowrap;overflow: hidden"></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"  data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel"></h4>
      </div>
      <!-- <div class="modal-body" > -->
      <div>
      	<div class="form-group">
	     	<div style="width:25%;float:left;text-align:right;height:20px;"></div>
	     	<div style="width:75%;float:left;height:20px;">
	     		<input type="hidden" class="form-control" name="sysId" id="sysId"/>
	     		<input type="hidden" class="form-control" name="integralFlag" id="integralFlag"/>
	     	</div>
     	</div>
     	<div class="form-group">
	     	<div style="width:25%;float:left;text-align:right;">手机号：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" name="userName" id="userName" placeholder="请输入手机号"/>
	     	</div>
     	</div>
     	<div class="form-group">
	     	<div style="width:25%;float:left;text-align:right;">真实姓名：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" name="realName" id="realName" placeholder="请输入用户真实姓名"/>
	     	</div>
     	</div>
     	<!-- <div class="form-group">
	    	<div style="display:none" id="sfzh">
		     	<div style="width:25%;float:left;text-align:right;">身份证号：</div>
		     	<div style="width:75%;float:left;">
		     		<input type="text" class="form-control" name="idCard" id="idCard"/>
		     	</div>
	    	</div>
	    </div> -->
	    <div class="form-group">
	     	<div style="width:25%;float:left;text-align:right">会员卡号：</div>
	     	<div style="width:75%;float:left;">
	     		<select class="form-control" name="cardNo" id="cardNo"></select>
	     	</div>
     	</div>
     	<div style="display:none" id="xfxm" class="form-group">
	     	<div style="width:25%;float:left;text-align:right">消费项目：</div>
	     	<div style="width:75%;float:left;">	
	     		<select class="form-control" name="spName" id="spName"></select>
	     	</div>
     	</div>
     	<div class="form-group">
	     	<div style="width:25%;float:left;text-align:right" id="je">消费金额：</div>
	     	<div style="width:75%;float:left;" id="czje">
	     		<input type="text" class="form-control" name="cardMoney" id="cardMoney" readonly/>
	     	</div>
	    </div>
     	<div class="form-group" id="jf" style="display:none">
	     	<div style="width:25%;float:left;text-align:right">可用积分：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" name="integral" id="integral" readonly/>
	     	</div>
	    </div>
     	<div class="form-group" id="sjzf" style="display:none">
	     	<div style="width:25%;float:left;text-align:right">实际支付：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" name="integralTrue" id="integralTrue" readonly/>
	     	</div>
	    </div>
	    <div style="width:25%;float:left;text-align:right">支付方式：</div>
     	<div style="width:75%;float:left;">
     		<select class="form-control" name="payType" id="payType">
     			<option value="1">微信</option>
     			<option value="0">会员卡</option>
     			<option value="2">支付宝</option>
     			<option value="3">其他方式</option>
     		</select>
     	</div>
     	<div style="display:none" id="zt" class="form-group">
	     	<div style="width:25%;float:left;text-align:right">状态：</div>
	     	<div style="width:75%;float:left;">	
	     		<select class="form-control" name="status" id="status">
	     			<option value="0">正常</option>
	     			<option value="1">禁用</option>
	     		</select>
	     	</div>
     	</div>
     	<div class="form-group" id="jfsy" style="display:none">
	     	<div style="width:40%;float:left;">
	     		<div style="float:right;">
		     		<input type="checkbox" class="form-control" name="isTrue" id="isTrue"/>
	     		</div>
	     	</div>
	     	<div style="width:60%;float:left;text-align:left">
	     		<div style="margin-top:3px;" id="isUseJf">&nbsp;不使用积分</div>
	     	</div>
	    </div>
	    <div class="form-group" id="cjadvert" style="display:none">
	     	<div style="width:40%;float:left;">
	     		<div style="float:right;">
		     		<input type="checkbox" class="form-control" id="isJoin"/>
	     		</div>
	     	</div>
	     	<div style="width:60%;float:left;text-align:left">
	     		<div style="margin-top:3px;" >&nbsp;参加活动</div>
	     	</div>
	    </div>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
        <button type="submit" class="btn btn-primary" onclick="updateMsCustom()">提交</button>
      </div>
    </div>
  </div>
</div>
</div>
<script type="text/javascript">
var dialog=null
var flag=0;//充值为0，消费为1
var isUseJf=true;//是否使用积分true使用，false不使用
$(document).ready(function(){ 
	$.ajax({
		type:"POST",
		url:"/serviceProject/getServiceProjectList?token="+localStorage.getItem("token"),
		contentType:'application/json',
		data:JSON.stringify({status:'0'}),
		success:function(res){
			if(res.status=="01"){
				for(var i=0;i<res.rows.length;i++){
					$("#spName").append("<option>"+res.rows[i].name+"</option>")
				}
				$("#spName").change(function(){
					$.ajax({
						type:"POST",
						url:"/serviceProject/getServiceProjectList?token="+localStorage.getItem("token"),
						contentType:'application/json',
						data:JSON.stringify({name:$("#spName").val()}),
						success:function(res){
							if(res.status=="01"){
								if(res.rows[0].amount == "" || res.rows[0].amount == null){
									$("#cardMoney").val(res.rows[0].price)
								}else{
									$("#cardMoney").val(res.rows[0].amount)
								}
								if($("#cardMoney").val() != "" && $("#integral").val() != ""){
									if(($("#cardMoney").val()/1-$("#integral").val()/1).toFixed(2) < 0){
										$("#integralTrue").val("0")
									}else{
										$("#integralTrue").val(($("#cardMoney").val()/1-$("#integral").val()/1).toFixed(2))
									}
								}else{
									alert("请先选择消费项目！")
									$("#integralTrue").val("")
								}
							}else{
								alert(res.message)
							}
						}
					})
				})
			}else{
				alert(res.message)
			}
		}
	})
	$.ajax({
		type:"POST",
		url:"/vipCard/getVipCardList?token="+localStorage.getItem("token"),
		contentType:'application/json',
		data:JSON.stringify({flag:"0"}),
		success:function(res){
			if(res.status=="01"){
				if(res.rows.length > 0){
					for(var i=0;i<res.rows.length;i++){
						$("#cardNo").append("<option>"+res.rows[i].cardNo+"</option>")
					}
				}
			}else{
				alert(res.message)
			}
		}
	})
	$("#cardNo").change(function(){
		$.ajax({
			type:"POST",
			url:"/vipCard/getVipCardList?token="+localStorage.getItem("token"),
			contentType:'application/json',
			data:JSON.stringify({cardNo:$("#cardNo").val()}),
			success:function(res){
				if(res.status=="01"){
					if(res.rows.length > 0){
						for(var i=0;i<res.rows.length;i++){
							$("#cardMoney").val(res.rows[i].cardMoney)
						}
					}
				}else{
					alert(res.message)
				}
			}
		})
	})
});
$('#table').bootstrapTable('destroy');
$('#table').bootstrapTable({
    url: "/msCustom/getMsCustomList?token="+localStorage.getItem("token"),
    pagination: true,
    sidePagenation:"client",
    search:true,
    method:"post",
    height:"400",
    responseHandler:function(res){
    	if(res.status == "01"){
    		return res;
    	}else{
    		return res.message;
    	}
    },
    columns: [{
   	    field: 'id',
   	    title: '序号',
   	    formatter: function (value, row, index) {
   	        return index+1;
   	    }
   	},{
    	field: 'sysId',
    	align:'center',
        title: '主键',
        visible: false
    },{
        field: 'realName',
        align:'center',
        title: '真实姓名',
        sortable : true
    },{
        field: 'userName',
        align:'center',
        title: '手机号/账号',
        sortable : true
    },{
        field: 'passWord',
        align:'center',
        title: '密码',
        sortable : true 
    },{
        field: 'cardNo',
        align:'center',
        title: '会员卡号',
        sortable : true
    },{
        field: 'cardMoney',
        align:'center',
        title: '金额',
        sortable : true
    },{
        field: 'integral',
        align:'center',
        title: '可用积分',
        sortable : true
    },{
        field: 'status',
        align:'center',
        title: '状态',
        formatter:function(value,row,index){
        	if(row.status=='0'){
        		return '<span style="color:#00ff00">正常</span>';
        	}else{
        		return '<span style="color:#FF0000">禁用</span>';
        	}
        }
    },{
        field: 'createTime',
        align:'center',
        title: '开卡时间',
        sortable : true
    },{
    	field:'operate',
    	align:'center',
    	title:'操作',
    	formatter:function(value,row,index){
    		if(row.cardNo == null || row.cardNo == ""){
	    		return '<button class="btn btn-info" id="editTable" data-toggle="modal" data-target="#myModal">绑卡</button>&nbsp;'+
	    		'<button class="btn btn-inverse" id="saveCustomDetail" data-toggle="modal" data-target="#myModal">充值</button>'
	    	}else{
	    		return '<button class="btn btn-danger" id="deltTable" data-toggle="modal" data-target="#myModal">消费</button>&nbsp;'+
	    		'<button class="btn btn-inverse" id="saveCustomDetail" data-toggle="modal" data-target="#myModal">充值</button>'
    		}
    	},
    	events: window.operateEvents = {
   			'click #editTable': function(e, value, row, index) {
   				dialog=0
   				$("#myModalLabel").html("绑卡")
   				$("#je").html("初始金额：")
   				$("#xfxm").hide()
   				$("#zt").show()
   				$("#sfzh").show()
   				$("#jf").hide()
   				$("#sjzf").hide()
   				$("#jfsy").hide()
   				$("#cjadvert").hide()
   				$("#userName").val(row.userName).attr("readOnly","true");
   				$("#realName").val(row.realName).attr("readOnly","true");
   				$("#idCard").val(row.idCard).attr("readOnly","true");
   				$("#cardNo").val(row.cardNo).removeAttr("disabled");
   				$("#status").val(row.status);
   				$("#sysId").val(row.sysId);
   				$("#czje").html('<input type="text" class="form-control" name="cardMoney" id="cardMoney" readonly/>')
   			},
   			'click #deltTable': function(e, value, row, index) {
   				dialog=3
   				flag=1;
   				if(row.integralFlag == "1"){
   					if(row.integral == "0"){
   						if(!$("#isTrue").is(':checked')){
   							if(row.integral == "0"){
	   							$("#isTrue").trigger('click')
   							}
   						}
   						$("#isTrue").attr("disabled","true");
   						$("#sjzf").hide()
   						$("#jfsy").hide()
   	   		        	$("#jf").hide()
   					}else{
   						if($("#isTrue").is(':checked')){
   							$("#isTrue").trigger('click')
   						}
   						$("#isTrue").removeAttr("disabled");
   						$("#jf").show()
	   		        	$("#jfsy").show()
	   		        	$("#sjzf").show()
   					}
   		        }else{
   		        	if(!$("#isTrue").is(':checked')){
						$("#isTrue").trigger('click')
					}
   		        	$("#isTrue").attr("disabled","true");
   		        	$("#sjzf").hide()
   		        	$("#jfsy").hide()
   		        	$("#jf").hide()
   		        }
   				$("#myModalLabel").html("消费")
   				$("#je").html("消费金额：")
   				$("#xfxm").show()
   				$("#zt").hide()
   				$("#sfzh").hide()
   				$("#cjadvert").hide()
   				$("#jfsy").show()
   				$("#integralTrue").val("")
   				$("#cardMoney").val("")
   				$("#realName").val(row.realName).attr("readOnly","true");
   				$("#userName").val(row.userName).attr("readOnly","true");
   				$("#cardNo").html("").append("<option>"+row.cardNo+"</option>").attr("disabled","true");
   				$("#sysId").val(row.sysId);
   				$("#spName").val("");
   				$("#payType").val("");
   				$("#integralFlag").val(row.integralFlag);
   				$("#integral").val(row.integral);
   				$("#czje").html('<input type="text" class="form-control" name="cardMoney" id="cardMoney"/>')
   				if($("#isTrue").is(':checked')){
   					isUseJf=false
   					$("#sjzf").hide()
   				    $("#jf").hide()
   				}else{
   					isUseJf=true
   					$("#sjzf").show()
   				    $("#jf").show()
   				}
   			},
   			'click #saveCustomDetail': function(e, value, row, index) {
   				dialog=3
   				flag=0;
   				$("#jf").hide()
   				$("#sjzf").hide()
   				$("#jfsy").hide()
   				$("#cjadvert").show()
   				$("#myModalLabel").html("充值")
   				$("#je").html("充值金额：")
   				$("#userName").val(row.userName).attr("readOnly","true");
   				$("#idCard").val("").show();
   				$("#cardNo").html("").append("<option>"+row.cardNo+"</option>").attr("disabled","true");
				$("#realName").val(row.realName).attr("readOnly","true");
   				$("#cardMoney").val("").removeAttr("readOnly");
   				$("#status").val("0");
   				$("#xfxm").hide();
   				$("#zt").hide();
   				$("#payType").val("");
   				$("#sfzh").hide();
   				$("#sysId").val(row.sysId);
   				$("#integralFlag").val(row.integralFlag);
   				$.ajax({
   					type:"post",
   					url:"/msAdvert/getMsAdvertList?token="+localStorage.getItem("token"),
   					contentType:'application/json',
   					data:JSON.stringify({"status":"0","type":"1"}),
   					success:function(res){
   						if(res.status=="01"){
   							if(res.rows.length == 1){
   								if(!$("#isJoin").is(":checked")){
   				   					$("#isJoin").trigger('click')
   				   				}
   								$("#czje").html('<select class="form-control" name="cardMoney" id="cardMoney"></select>')
   								for(var i=0;i<res.rows[0].price.split(",").length;i++){
   									$("#cardMoney").append(
	   									'<option value="'+(res.rows[0].price.split(",")[i]+","+res.rows[0].freeMoney.split(",")[i])+'">充'+res.rows[0].price.split(",")[i]+'送'+res.rows[0].freeMoney.split(",")[i]+'</option>'
   									)
   								}
   							}else{
   								$("#cjadvert").hide()
   								$("#czje").html('<input type="text" class="form-control" name="cardMoney" id="cardMoney"/>')
   							}
   						}else{
   							alert(res.message)
   						}
   					}
   				})
   			}
   		}
    }]
});
$("#isJoin").click(function(){
	if(!$("#isJoin").is(":checked")){
		$("#czje").html('<input type="text" class="form-control" name="cardMoney" id="cardMoney"/>')
		$("#cjadvert").hide();
	}
})
function updateMsCustom(){
	if(dialog==0){
		$.ajax({
			type:"post",
			url:"/msCustom/updateMsCustom?token="+localStorage.getItem("token"),
			contentType:'application/json',
			data:JSON.stringify({"status":$("#status").val(),"sysId":$("#sysId").val(),"idCard":$("#idCard").val(),"cardNo":$("#cardNo").val(),"cardMoney":$("#cardMoney").val(),"integral":$("#integral").val()==""?"0":$("#integral").val()}),
			success:function(res){
				if(res.status=="01"){
					alert(res.rows)
					$("#myModal").modal('hide');
					$("#table").bootstrapTable('refresh');
				}else{
					alert(res.message)
				}
			}
		})
	}else if(dialog==1){
		if(checkParmas()){
			$.ajax({
				type:"post",
				url:"/msCustom/saveMsCustom?token="+localStorage.getItem("token"),
				contentType:'application/json',
				data:JSON.stringify({"status":$("#status").val(),"idCard":$("#idCard").val(),"userName":$("#userName").val(),"realName":$("#realName").val(),"cardNo":$("#cardNo").val(),"cardMoney":$("#cardMoney").val(),"payType":$("#payType").val()}),
				success:function(res){
					if(res.status=="01"){
						alert(res.rows)
						$("#myModal").modal('hide');
						$("#table").bootstrapTable('refresh');
					}else{
						alert(res.message)
					}
				}
			})
		}
	}else if(dialog==3){
		if($("#payType").val() == "0"){
			alert("充值不支持会员卡！\n请选择其他支付方式！")
		}else{
			var cm = $("#cardMoney").val().split(",");
			var cardMoney = 0 ,freeMoney = 0;
			console.log(cm.length)
			if(cm.length == 2){
				cardMoney = cm[0];
				freeMoney = cm[1];
			}else{
				cardMoney=$("#cardMoney").val();
			}
			var integral=$("#integral").val();
			$.ajax({
				type:"post",
				url:"/msCustom/updateMsCustomByCardMoney?token="+localStorage.getItem("token"),
				contentType:'application/json',
				data:JSON.stringify({"userName":$("#userName").val(),"cardNo":$("#cardNo").val(),"cardMoney":cardMoney,"spName":$("#spName").val(),"sysId":$("#sysId").val(),"integral":integral,integralFlag:$("#integralFlag").val(),integralTrue:$("#integralTrue").val(),flag:flag,isUseJf:isUseJf,payType:$("#payType").val(),freeMoney:freeMoney}),
				success:function(res){
					if(res.status=="01"){
						alert(res.message)
						$("#myModal").modal('hide');
						$("#table").bootstrapTable('refresh');
					}else{
						alert(res.message)
					}
				}
			})
		}
	}
}
$("#saveMsCustom").click(function(){
	dialog=1
	$("#myModalLabel").html("新增")
	$("#jf").hide()
	$("#sjzf").hide()
	$("#jfsy").hide()
	$("#realName").val("").removeAttr("readOnly");
	$("#userName").val("").removeAttr("readOnly");
	$("#idCard").val("").show().removeAttr("readOnly");
	$("#cardNo").val("").removeAttr("disabled");
	$("#cardMoney").val("").attr("readOnly","true");
	$("#status").val("0");
	$("#payType").val("");
	$("#xfxm").hide();
	$("#zt").show();
	$("#sfzh").show();
	//formValidator()
})
//表单验证
function checkParmas() {
	if($("#userName").val() == ""){
		alert("手机号不能为空！")
		return false;
	}else{
		return true;
	}
};
$("#isTrue").click(function(){
	if($("#isTrue").is(':checked')){
		isUseJf=false
		$("#sjzf").hide()
	    $("#jf").hide()
	}else{
		isUseJf=true
		$("#sjzf").show()
	    $("#jf").show()
	}
})
</script>
<script src="getMsUser.js"></script>
</body>
</html>