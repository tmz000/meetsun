<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/matrix-style2.css" />
<link rel="stylesheet" href="bootstrap-table/bootstrap-dialog.css" />

<link rel="stylesheet" href="css/bootstrap.min.css" />
<link rel="stylesheet" href="css/font.css" />
<link rel="stylesheet" href="css/uploadImg.css">
<link rel="stylesheet" href="bootstrap-table/bootstrap-table.css"/>
<link rel="stylesheet" href="css/bootstrap-datetimepicker.css"/>

<script src="../js/jquery-3.5.1.min.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src="bootstrap-table/bootstrap-table.js"></script>
<script src="js/bootstrap-datetimepicker.js"></script>
<script src="js/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="bootstrap-table/bootstrap-dialog.js"></script>
<script src="bootstrap-table/bootstrap-table-zh-CN.js"></script>
</head>
<body>
<div id="body">
<div id="content">
  <div id="content-header">
      <h1>活动</h1>
  </div>
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="widget-box">
          <div class="widget-content">
       		<button class="btn btn-info" id="saveButton" data-toggle="modal" data-target="#myModal" style="float:right">新增</button>
          	<table id="table" style="white-space:nowrap;overflow: hidden"></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" style="margin-top:-40px;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeDiolag"><span aria-hidden="true">&times;</span></button>
        <ul class="nav nav-tabs" role="tablist">
			<li role="presentation" class="active" data-id="dialog1" id="xmhd"><a href="#">项目活动</a></li>
			<li role="presentation" data-id="dialog2" id="czhd"><a href="#">充值活动</a></li>
			<li role="presentation" data-id="dialog3" id="jfhd"><a href="#">积分抵现</a></li>
		</ul>
      </div>
      <!-- <div class="modal-body" > -->
      <div style="margin-top:-30px;" id="dialog1">
     	<div style="width:25%;float:left;text-align:right;height:20px;"></div>
     	<div style="width:75%;float:left;height:20px;">
     		<input type="hidden" class="form-control" name="sysId" id="sysId"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right;">活动名称：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="adName" id="adName" autocomplete="off"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right">有效期：</div>
     	<div style="width:75%;float:left;">
	        <input type="text" class="form-control form_datetime" id="toDate" autocomplete="off" onFocus="this.blur()">
	        <script type="text/javascript">
		        $(".form_datetime").datetimepicker({
		            language: "zh-CN",
		            format: "yyyy-mm-dd",
		            autoclose: true,
		            minView: "month",
		            startDate : new Date()
		        });
	        </script>
     	</div>
     	<div style="width:25%;float:left;text-align:right">活动项目：</div>
     	<div style="width:75%;float:left;">	
     		<select class="form-control" name="spName" id="spName">
     		</select>
     	</div>
     	<div style="width:25%;float:left;text-align:right;">活动介绍：</div>
     	<div style="width:75%;float:left;">
     		<!-- <input type="text" class="form-control" name="adContent" id="adContent"/> -->
     		<textarea class="form-control" name="adContent" id="adContent"/></textarea>
     	</div>
     	<div id="hdtp">
	     	<div style="width:25%;float:left;text-align:right;">活动图片：</div>
	     	<div style="width:75%;float:left;">
	        	<input type="file" name="file" accept="image/*" id="photoAdrr" multiple="multiple">
	     	</div>
     	</div>
     	<div style="width:25%;float:left;text-align:right">价格：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="price" id="price" readonly/>
     	</div>
     	<div style="width:25%;float:left;text-align:right">折扣数：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="discount" id="discount" autocomplete="off" onkeyup="value=value.replace(/[^\d^\.]+/g,'').replace('.','$#$').replace(/\./g,'').replace('$#$','.').replace(/\b(0+)/gi,'')"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right">优惠金额：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="freeMoney" id="freeMoney" readonly/>
     	</div>
     	<div style="width:25%;float:left;text-align:right">成交金额：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="amount" id="amount" readonly/>
     	</div>
     	<div style="width:25%;float:left;text-align:right">状态：</div>
     	<div style="width:75%;float:left;">	
     		<select class="form-control" name="status" id="status">
     			<option value="0">正常</option>
     			<option value="1">过期</option>
     		</select>
     	</div>
      </div>
      <!-- <div class="modal-body" > -->
      <div style="margin-top:-30px;" id="dialog2" style="display:none">
     	<div style="width:25%;float:left;text-align:right;height:20px;"></div>
     	<div style="width:75%;float:left;height:20px;">
     		<input type="hidden" class="form-control" name="sysId" id="sysId1"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right;">活动名称：</div>
     	<div style="width:75%;float:left;">
     		<input type="text" class="form-control" name="adName" id="adName1" autocomplete="off"/>
     	</div>
     	<div style="width:25%;float:left;text-align:right">有效期：</div>
     	<div style="width:75%;float:left;">
	        <input type="text" class="form-control form_datetime" id="toDate1" autocomplete="off" onFocus="this.blur()">
	        <script type="text/javascript">
		        $(".form_datetime").datetimepicker({
		            language: "zh-CN",
		            format: "yyyy-mm-dd",
		            autoclose: true,
		            minView: "month",
		            startDate : new Date()
		        });
	        </script>
     	</div>
     	<div style="width:25%;float:left;text-align:right;">活动介绍：</div>
     	<div style="width:75%;float:left;">
     		<!-- <input type="text" class="form-control" name="adContent" id="adContent"/> -->
     		<textarea class="form-control" name="adContent" id="adContent1"/></textarea>
     	</div>
     	<div id="price11">
	     	<div style="width:25%;float:left;text-align:right">充值金额：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" id="price1" onkeyup="value=value.replace(/[^\d^\,]+/g,'').replace(',','$#$').replace(/\./g,'').replace('$#$',',').replace(/\b(0+)/gi,'')"/>
	     	</div>
     	</div>
     	<div id="freeMoney11">
	     	<div style="width:25%;float:left;text-align:right">优惠金额：</div>
	     	<div style="width:75%;float:left;">
	     		<input type="text" class="form-control" id="freeMoney1" onkeyup="value=value.replace(/[^\d^\,]+/g,'').replace(',','$#$').replace(/\./g,'').replace('$#$',',').replace(/\b(0+)/gi,'')"/>
	     	</div>
     	</div>
     	<div id="hdtp1">
	     	<div style="width:25%;float:left;text-align:right;">活动图片：</div>
	     	<div style="width:75%;float:left;">
	     		<div class="main">
			        <div class="upload-content">
			            <div class="content-img">
			                <ul class="content-img-list"></ul>
			                <div class="file" id="showFile">
			                    <i class="gcl gcladd"></i>
			                    <input type="file" name="file" accept="image/*" id="photoAdrr1" multiple="multiple">
			                </div>
			            </div>
			            <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" style="display: none;margin-left:-20px;">
			                <div class="modal-dialog modal-lg" role="document">
			                    <div class="modal-content">
			                    	<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			                    	<div class="show">
									</div>
								</div>
			                </div>
			            </div>
			        </div>
			    </div>
	     	</div>
     	</div>
     	<div style="width:25%;float:left;text-align:right">状态：</div>
     	<div style="width:75%;float:left;">	
     		<select class="form-control" name="status" id="status1">
     			<option value="0">正常</option>
     			<option value="1">过期</option>
     		</select>
     	</div>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
        <button type="button" class="btn btn-primary" onclick="submit()">提交</button>
      </div>
    </div>
  </div>
</div>
</div>
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" style="height:300px;width:400px;">
	<img src="" id="imgAdrr" style="width:100%;height:100%"/><button style="margin:-295px 10px 0 0;" type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeImg">关闭</button>
</div>
<script src="js/uploadImg.js"></script>
<script type="text/javascript">
$("#myModal1").hide()
$("#myModal").hide()
$("#closeImg").click(function(){
	$("#myModal1").hide()
})
var type="0";
$('.nav-tabs li').click(function(){
　　$(this).addClass('active').siblings().removeClass('active');
　　var _id = $(this).attr('data-id');
　　$('.tabs-contents').find('#'+_id).addClass('active').siblings().removeClass('active');

　　switch(_id){
　　　　case "dialog1":
		dialog1();
　　　　　　break;
　　　　case "dialog2":
		type="1"
　　　　　　dialog2();
　　　　　　break;
　　　　case "dialog3":
		type="2"
　　　　　　dialog2();
　　　　　　break;
　　　　default:
　　　　　　dialog1();
　　　　　　break;
　　}
});
function dialog1(){
	$("#dialog1").show();
　　　$("#dialog2").hide();
}
function dialog2(){
	$("#dialog1").hide();
	$("#dialog2").show();
	if(type=="2"){
		$("#adName1").val("开启积分抵现活动");
		$("#adContent1").val("限时开启积分抵现活动，凡是在本店消费过产品，均有可用积分抵现！");
		$("#price11").hide()
		$("#freeMoney11").hide()
	}else{
		$("#adName1").val("");
		$("#adContent1").val("");
		$("#toDate1").val("");
		$("#price11").show()
		$("#freeMoney11").show()
	}
}
var dialog=null
$(document).ready(function(){ 
	$("#dialog1").show();
	$("#dialog2").hide();
	$.ajax({
		type:"POST",
		url:"/serviceProject/getServiceProjectList?token="+localStorage.getItem("token"),
		contentType:'application/json',
		data:JSON.stringify({sysId:''}),
		success:function(res){
			if(res.status=="01"){
				for(var i=0;i<res.rows.length;i++){
					$("#spName").append("<option value='"+res.rows[i].sysId+"'>"+res.rows[i].name+"</option>")
				}
			}else{
				alert(res.message)
			}
		}
	})
});
//产品活动返回相应价格
$("#spName").change(function(){
	$.ajax({
		type:"POST",
		url:"/serviceProject/getServiceProjectList?token="+localStorage.getItem("token"),
		contentType:'application/json',
		data:JSON.stringify({sysId:$("#spName").val()}),
		success:function(res){
			if(res.status=="01"){
				for(var i=0;i<res.rows.length;i++){
					$("#price").val(res.rows[i].price)
				}
			}else{
				alert(res.message)
			}
		}
	})
})
$("#discount").keyup(function(){
	var num = 0;
	var freeMoney=0;
	var count = $("#count").val();
	var discount = $("#discount").val();
	var price = $("#price").val();
	if(discount/1 > 10){
		$("#discount").val("")
		alert("请输入1-10之间的折扣数！")
	}else{
		if(price != ""){
			freeMoney = (price/1-price*discount*0.1).toFixed(2);
			if(count != "" && count != undefined){
				freeMoney = (freeMoney*count/1).toFixed(2);
				$("#freeMoney").val(freeMoney); 
				num = (price*discount*count*0.1).toFixed(2);
			}else{
				$("#freeMoney").val(freeMoney); 
				num = (price*discount/10).toFixed(2);
			}
		}else{
			$("#discount").val("")
			alert("产品和价格不能为空！")
			//alert("请先输入折扣数（0-10直接的整数或者小数）！")
		}
		if(num >= 0){
			$("#amount").val(num)
			$("#trueMoney").val(num)
		}else{
			$("#amount").val("0")
			$("#trueMoney").val("0")
			alert("折扣数过低！")
		}
	}
})
$('#table').bootstrapTable('destroy');
$('#table').bootstrapTable({
    url: "/msAdvert/getMsAdvertList?token="+localStorage.getItem("token"),
    pagination: true,
    search:true,
    method:"post",
    height:"400",
    queryParams :queryParams,
    responseHandler:function(res){
    	if(res.status == "01"){
    		return res;
    	}else{
    		return res.message;
    	}
    },
    columns: [{
   	    field: 'id',
   	    title: '序号',
   	    formatter: function (value, row, index) {
   	        return index+1;
   	    }
   	},{
    	field: 'sysId',
    	align:'center',
        title: '主键',
        visible: false
    },{
        field: 'adName',
        align:'left',
        halign:"center",
        title: '活动名称',
        sortable : true
    },{
        field: 'adContent',
        align:'left',
        halign:"center",
        title: '活动介绍',
        formatter:paramsMatter,
        cellStyle:formatTableUnit,
        sortable : true
    },{
        field: 'spName',
        align:'left',
        halign:"center",
        title: '活动项目',
        sortable : true
    },{
        field: 'clickNum',
        align:'center',
        title: '点击次数',
        sortable : true
    },{
        field: 'price',
        align:'center',
        title: '价格',
        sortable : true
    },{
        field: 'discount',
        align:'center',
        title: '折扣数',
        sortable : true
    },{
        field: 'freeMoney',
        align:'center',
        title: '优惠金额',
        sortable : true
    },{
        field: 'amount',
        align:'center',
        title: '成交金额',
        sortable : true
    },{
        field: 'toDate',
        align:'center',
        title: '有效期',
        sortable : true
    },{
        field: 'type',
        align:'center',
        title: '类型',
        formatter:function(value,row,index){
        	if(row.type=='0'){
        		return '项目活动';
        	}else if(row.type=='1'){
        		return '充值活动';
        	}else{
        		return "积分抵现";
        	}
        }
    },{
    	field: 'photoAdrr',
    	title: '活动图片',
       	formatter:function(value,row,index){
            var s = '<a  data-toggle="modal" data-target="#myModal1"  id="showPhoto"  href="javascript:void(0)"><img style="width:70;height:20px;"  src="'+row.photoAdrr+'" /></a>';
            return s;
        },
        events: 'operateEvents'
    },{
        field: 'status',
        align:'center',
        title: '状态',
        formatter:function(value,row,index){
        	if(row.status=='0'){
        		return '<span style="color:#00ff00">正常</span>';
        	}else{
        		return '<span style="color:#FF0000">过期</span>';
        	}
        }
    },{
        field: 'userName',
        align:'center',
        title: '发布人',
        sortable : true
    },{
        field: 'createTime',
        align:'center',
        title: '发布时间',
        sortable : true
    },{
    	field:'operate',
    	align:'center',
    	title:'操作',
    	events: window.operateEvents = {
   			'click #editTable': function(e, value, row, index) {
   				$("#hdtp").hide()
   				$("#hdtp1").hide()
   				dialog=0
   				if(row.type=="0"){
   					$("#xmhd").trigger('click');
	   				$("#xmhd").show();
	   				$("#czhd").hide();
	   				$("#jfhd").hide();
	   				$("#dialog1").show();
	   				$("#dialog2").hide();
	   				$("#adName").val(row.adName);
	   				$("#price").val(row.price);
	   				$("#remark").val(row.remark);
	   				$("#toDate").val(row.toDate);
	   				$("#spName").val(row.spId).attr("disabled","disabled");
	   				$("#freeMoney").val(row.freeMoney);
	   				$("#adContent").val(row.adContent);
	   				$("#discount").val(row.discount);
	   				$("#amount").val(row.amount);
	   				$("#sysId").val(row.sysId);
	   				$("#status").val(row.status);
   				}else if(row.type=="1"){
   					$("#czhd").trigger('click');
   					$("#xmhd").hide();
   					$("#jfhd").hide();
	   				$("#czhd").show();
	   				$("#dialog2").show();
	   				$("#dialog1").hide();
   					$("#adName1").val(row.adName);
	   				$("#toDate1").val(row.toDate);
	   				$("#adContent1").val(row.adContent);
	   				$("#freeMoney1").val(row.freeMoney);
	   				$("#price1").val(row.price);
	   				$("#sysId1").val(row.sysId);
	   				$("#status1").val(row.status);
   				}else{
   					$("#jfhd").trigger('click');
   					$("#xmhd").hide();
   					$("#czhd").hide();
	   				$("#jfhd").show();
	   				$("#dialog2").show();
	   				$("#dialog1").hide();
   					$("#adName1").val(row.adName);
	   				$("#toDate1").val(row.toDate);
	   				$("#adContent1").val(row.adContent);
	   				$("#sysId1").val(row.sysId);
	   				$("#status1").val(row.status);
   				}
   			},
   			'click #deltTable': function(e, value, row, index) {
   				if(confirm("确定要执行该操作？")){
   					$.ajax({
   						type:"post",
   						url:"/msAdvert/deleteMsAdvert?token="+localStorage.getItem("token"),
   						data:JSON.stringify({"sysId":row.sysId}),
   						contentType:'application/json',
   						success:function(res){
   							if(res.status=="01"){
   								$("#myModal").modal('hide');
   								$("#table").bootstrapTable('refresh');
   							}else{
   								alert(res.message)
   							}
   						}
   					})
   				}
   			}
   		},
    	formatter:function(value,row,index){
    		return '<button class="btn" id="showTable"><a href="/detail?sysId='+row.sysId+'&token='+localStorage.getItem("token")+'" style="text-decoration:none">查看</a></button>&nbsp;<button class="btn btn-info" id="editTable" data-toggle="modal" data-target="#myModal">修改</button>&nbsp;'+
    		'<button class="btn btn-danger" id="deltTable">删除</button>'
    	}
    }]
});

window.operateEvents = {
    'click #showPhoto': function (e, value, row, index) {
    	$("#imgAdrr").attr('src', row.photoAdrr)
    },
};

function submit(){
	var data=null;
	var form = new FormData();
	if(type=="0"){
		data=JSON.stringify({
			"status":$("#status").val(),
			"adName":$("#adName").val(),
			"toDate":$("#toDate").val(),
			"spId":$("#spName").val(),
			"adContent":$("#adContent").val(),
			"price":$("#price").val(),
			"discount":$("#discount").val(),
			"amount":$("#amount").val(),
			"sysId":$("#sysId").val(),
			"freeMoney":$("#freeMoney").val(),
			"status":$("#status").val(),
			"type":type
		})
		form.append("file", document.getElementById("photoAdrr").files[0]);
     	form.append("vo", data);
	}else{
		data=JSON.stringify({
			"adName":$("#adName1").val(),
			"toDate":$("#toDate1").val(),
			"adContent":$("#adContent1").val(),
			"sysId":$("#sysId1").val(),
			"price":$("#price1").val(),
			"status":$("#status1").val(),
			"freeMoney":$("#freeMoney1").val(),
			"type":type
		})
		form.append("file", imgFile[0]);
     	form.append("vo", data);
	}
	if(dialog==0){
		$.ajax({
			type:"post",
			url:"/msAdvert/updateMsAdvert?token="+localStorage.getItem("token"),
			contentType:'application/json',
			data:data,
			success:function(res){
				if(res.status=="01"){
					alert(res.rows)
					$("#myModal").modal('hide');
					$("#table").bootstrapTable('refresh');
				}else{
					alert(res.message)
				}
			}
		})
	}else{
		if(checkParmas(type)){
			$.ajax({
				type:"post",
				url:"/msAdvert/saveMsAdvert?token="+localStorage.getItem("token"),
				contentType:false,
				processData: false,
				data:form,
				success:function(res){
					if(res.status=="01"){
						alert(res.rows)
						$("#myModal").modal('hide');
						$("#table").bootstrapTable('refresh');
					}else{
						alert(res.message)
					}
				}
			})
		};
	}
}
$("#saveButton").click(function(){
	dialog=1
	$("#xmhd").show();
	$("#czhd").show();
	$("#jfhd").show();
	$("#hdtp").show()
	$("#hdtp1").show()
	$("#adName").val("");
	$("#photoAdrr").val("");
	$("#photoAdrr1").val("");
	$("#price").val("");
	$("#remark").val("");
	$("#toDate").val("");
	$("#toDate1").val("");
	$("#spName").val("").removeAttr("disabled");
	$("#adContent").val("");
	$("#discount").val("");
	$("#amount").val("");
	$("#status").val("");
	$("#sysId").val("");
	$("#sysId1").val("");
	$("#price1").val("");
	$("#freeMoney1").val("");
	if(type=="0"){
		$("#dialog1").show();
		$("#dialog2").hide();
		$("#freeMoney").val("0");
	}else if(type=="1"){
		$("#dialog2").show();
		$("#dialog1").hide();
		$("#adName1").val("");
		$("#adContent1").val("");
	}else{
		$("#dialog2").show();
		$("#dialog1").hide();
		$("#adName1").val("开启积分抵现活动");
		$("#adContent1").val("限时开启积分抵现活动，凡是在本店消费过产品，均有可用积分抵现！");
	}
	
	$(".content-img-list").find("li").remove();
	imgSrc.splice(index, 1);
    imgFile.splice(index, 1);
    imgName.splice(index, 1);
    var boxId = ".content-img-list";
    var index = $(this).parent().parent().parent().index();
    addNewContent(boxId);
	$("#showFile").show();
	
	
	
})

//表格超出宽度鼠标悬停显示td内容
function paramsMatter(value, row, index) {
    var span = document.createElement("span");
    span.setAttribute("title", value);
    span.innerHTML = value;
    return span.outerHTML;
}
//td宽度以及内容超过宽度隐藏
function formatTableUnit(value, row, index) {
    return {
        css: {
            "white-space": "nowrap",
            "text-overflow": "ellipsis",
            "overflow": "hidden",
            "max-width": "150px"
        }
    }
}        

$("#discount").keyup(function(){
	if($("#price").val() != null || $("#price").val() != ""){
		$("#amount").val(($("#price").val()*$("#discount").val()/10).toFixed(2))
	}
})

function queryParams(){
	var params = {
		type:""	
	}
	return params;
}
function checkParmas(type){
	if(type=="0"){
		if($("#adName").val() == ""){
			alert("活动名称不能为空！")
			return false;
		}else if($("#toDate").val() == ""){
			alert("有效期不能为空！")
			return false;
		}else if($("#spName").val() == ""){
			alert("请选择活动项目！")
			return false;
		}else if($("#adContent").val() == ""){
			alert("活动介绍不能为空！")
			return false;
		}else if($("#price").val() == ""){
			alert("价格不能为空！")
			return false;
		}else if($("#discount").val() == ""){
			alert("折扣数不能为空！")
		}else if(document.getElementById("photoAdrr").files[0]==undefined){
			alert("请选择活动图片！")
			return false;
		}else{
			return true;
		}
	}else{
		if($("#adName1").val() == ""){
			alert("活动名称不能为空！")
			return false;
		}else if($("#toDate1").val() == ""){
			alert("有效期不能为空！")
			return false;
		}else if($("#adContent1").val() == ""){
			alert("活动介绍不能为空！")
			return false;
		}else if(imgFile[0]==undefined){
			alert("请选择活动图片！")
			return false;
		}else{
			return true;
		}
	}
}
$("#closeDiolag").click(function(){
	$("#myModal").hide()
})
</script>
<script src="getMsUser.js"></script>
</body>
</html>
